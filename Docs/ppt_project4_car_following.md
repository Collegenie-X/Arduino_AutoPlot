# 🔴 Project 4: 자동차 따라가기

---

## Slide 1: 표지

### 🚗 자동차 따라가기 시스템
**초음파 센서 기반 거리 유지 제어**

- 실제 자율주행 연계: 적응형 순항 제어 (ACC)
- 난이도: ★★★★☆ (중상급)
- 소요 시간: 2시간

---

## Slide 2: 학습 목표

### 🎯 이 프로젝트를 마치면...

1. **거리 기반 속도 제어** 원리를 이해할 수 있다
2. **비례 제어 (P 제어)** 개념을 적용할 수 있다
3. **오차 기반 제어**를 구현할 수 있다
4. **부드러운 추종** 알고리즘을 만들 수 있다
5. 실제 **ACC** 기술을 이해할 수 있다

---

## Slide 3: 실제 자율주행 연계

### 🚗 적응형 순항 제어 (ACC)

```
┌─────────────────────────────────────────────┐
│           실제 ACC 시스템                   │
├─────────────────────────────────────────────┤
│                                             │
│   [레이더/카메라] → [앞차 인식]             │
│          │              │                   │
│          ▼              ▼                   │
│   [거리 측정] → [상대 속도 계산]            │
│                        │                    │
│                        ▼                    │
│              [목표 거리와 비교]             │
│                        │                    │
│         ┌──────────────┼──────────────┐    │
│         │              │              │    │
│         ▼              ▼              ▼    │
│      [가까움]       [적정]        [멂]     │
│         │              │              │    │
│         ▼              ▼              ▼    │
│      [감속]       [속도유지]      [가속]   │
│                                             │
├─────────────────────────────────────────────┤
│           우리 프로젝트                      │
├─────────────────────────────────────────────┤
│                                             │
│   [초음파 센서] → [거리 측정]               │
│                        │                    │
│                        ▼                    │
│              [목표 30cm와 비교]             │
│                        │                    │
│                        ▼                    │
│              [비례 제어로 속도 결정]        │
│                                             │
└─────────────────────────────────────────────┘
```

**실제 사례**: 현대 스마트 크루즈 컨트롤, 테슬라 TACC, 트럭 군집 주행

---

## Slide 4: 시스템 개요

### 📊 따라가기 시스템 구조

```
┌─────────────────────────────────────────────┐
│                                             │
│   [앞 물체]          목표 거리: 30cm        │
│       ▲                                     │
│       │                                     │
│       │  ←─── 현재 거리 측정 ───→          │
│       │                                     │
│   ┌───┴───┐                                │
│   │ 초음파 │                                │
│   │ 센서   │                                │
│   └───┬───┘                                │
│       │                                     │
│   ┌───┴───┐                                │
│   │ Arduino│ ← 오차 계산 & 제어            │
│   └───┬───┘                                │
│       │                                     │
│   ┌───┴───┐                                │
│   │ 모터   │ ← 속도 조절                   │
│   └───────┘                                │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 5: 오차 기반 제어 개념

### 📐 오차 (Error) 계산

```
┌─────────────────────────────────────────────┐
│                                             │
│   오차 = 현재 거리 - 목표 거리              │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │                                     │  │
│   │  목표 거리: 30cm                    │  │
│   │                                     │  │
│   │  [앞차]───────30cm──────[내차]     │  │
│   │     │                      │        │  │
│   │     └──────────────────────┘        │  │
│   │           오차 = 0                  │  │
│   │                                     │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   오차 해석:                                │
│                                             │
│   오차 > 0  →  앞차가 멂  →  전진 필요     │
│   오차 = 0  →  적정 거리  →  속도 유지     │
│   오차 < 0  →  앞차가 가까움  →  후진/정지 │
│                                             │
│   예시:                                     │
│   - 현재 50cm, 목표 30cm → 오차 = +20     │
│   - 현재 30cm, 목표 30cm → 오차 = 0       │
│   - 현재 15cm, 목표 30cm → 오차 = -15     │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 6: 거리-속도 매핑

### 📊 오차에 따른 속도 결정

```
┌─────────────────────────────────────────────┐
│                                             │
│   거리(cm)    오차     동작        속도     │
│   ─────────────────────────────────────────│
│   < 20       < -10    🔴 후진     -100     │
│   20 ~ 25    -10 ~ -5 🟠 정지       0      │
│   25 ~ 35    -5 ~ +5  🟢 저속      50      │
│   35 ~ 50    +5 ~ +20 🟡 전진     100      │
│   > 50       > +20    🔵 빠른전진  150      │
│                                             │
│   그래프:                                   │
│                                             │
│   속도 ▲                                    │
│   150 │              ╱                      │
│   100 │            ╱                        │
│    50 │     ────═╱                          │
│     0 │───══════                            │
│  -100 │══                                   │
│       └──────────────────────────▶ 거리     │
│        10  20  30  40  50  60              │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 7: 기본 따라가기 알고리즘

### 🔄 단계별 제어 순서도

```
┌─────────────────────────────────────────────┐
│                                             │
│           [followCar 시작]                  │
│                   │                         │
│                   ▼                         │
│           [거리 측정]                       │
│                   │                         │
│                   ▼                         │
│        [유효한 값?] ─── No ───→ [정지]     │
│                   │                         │
│                  Yes                        │
│                   │                         │
│                   ▼                         │
│           [오차 계산]                       │
│     error = distance - 30                   │
│                   │                         │
│                   ▼                         │
│        ┌─────────┼─────────┐               │
│        │         │         │               │
│        ▼         ▼         ▼               │
│   [error<-10] [|error|<5] [error>10]       │
│        │         │         │               │
│        ▼         ▼         ▼               │
│     [후진]    [정지]    [전진]             │
│        │         │         │               │
│        └─────────┼─────────┘               │
│                  │                          │
│                  ▼                          │
│            [반복]                           │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 8: 기본 따라가기 코드

### 💻 단계별 제어 구현

```arduino
#define TARGET_DISTANCE 30  // 목표 거리 (cm)
#define TOLERANCE 5         // 허용 오차 (cm)

void followCarBasic() {
    int currentDist = measureDistance();
    
    // 유효성 검사
    if (currentDist <= 0 || currentDist > 100) {
        Stop();  // 앞차 없음 또는 측정 실패
        return;
    }
    
    // 오차 계산
    int error = currentDist - TARGET_DISTANCE;
    
    // 단계별 제어
    if (error < -10) {
        // 너무 가까움: 후진
        Backward();
    }
    else if (error < -TOLERANCE) {
        // 조금 가까움: 정지
        Stop();
    }
    else if (error < TOLERANCE) {
        // 적정 거리: 저속 유지
        Forward_Slow();
    }
    else if (error < 20) {
        // 조금 멂: 전진
        Forward();
    }
    else {
        // 많이 멂: 빠른 전진
        Forward_Fast();
    }
}
```

---

## Slide 9: 비례 제어 (P 제어) 개념

### 📐 PID 제어 중 P (Proportional)

```
┌─────────────────────────────────────────────┐
│                                             │
│   비례 제어 공식:                           │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │                                     │  │
│   │   속도 = Kp × 오차                  │  │
│   │                                     │  │
│   │   Kp: 비례 상수 (게인)              │  │
│   │   오차: 현재 거리 - 목표 거리       │  │
│   │                                     │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   원리:                                     │
│   - 오차가 크면 → 속도도 크게              │
│   - 오차가 작으면 → 속도도 작게            │
│   - 오차가 0이면 → 속도도 0               │
│                                             │
│   예시 (Kp = 5):                           │
│   - 오차 +20 → 속도 = 5 × 20 = 100 (전진) │
│   - 오차 +5  → 속도 = 5 × 5 = 25 (저속)   │
│   - 오차 0   → 속도 = 5 × 0 = 0 (정지)    │
│   - 오차 -10 → 속도 = 5 × -10 = -50 (후진)│
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 10: 비례 제어 블록 다이어그램

### 🔄 제어 루프

```
┌─────────────────────────────────────────────┐
│                                             │
│   ┌─────────┐                              │
│   │ 목표    │                              │
│   │ 30cm    │                              │
│   └────┬────┘                              │
│        │                                    │
│        ▼         ┌─────────┐               │
│   ┌────●────┐   │  Kp     │               │
│   │ 오차    │───│ × 오차  │───┐           │
│   │ 계산    │   │  = 속도 │   │           │
│   └────▲────┘   └─────────┘   │           │
│        │                       │           │
│        │                       ▼           │
│        │              ┌─────────┐          │
│        │              │  모터   │          │
│        │              │  제어   │          │
│        │              └────┬────┘          │
│        │                   │               │
│        │                   ▼               │
│        │              ┌─────────┐          │
│   ┌────┴────┐        │  스마트 │          │
│   │ 현재    │◄───────│   카    │          │
│   │ 거리    │        └─────────┘          │
│   └─────────┘                              │
│                                             │
│   피드백 루프: 거리 측정 → 오차 → 속도 →  │
│               이동 → 거리 변화 → ...       │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 11: 비례 제어 코드

### 💻 P 제어 구현

```arduino
#define TARGET_DISTANCE 30  // 목표 거리 (cm)
#define Kp 5               // 비례 상수

void followCarSmooth() {
    int currentDist = measureDistance();
    
    // 유효성 검사
    if (currentDist <= 0 || currentDist > 100) {
        Stop();
        return;
    }
    
    // 오차 계산
    int error = currentDist - TARGET_DISTANCE;
    
    // 비례 제어: 속도 = Kp × 오차
    int speed = Kp * error;
    
    // 속도 제한 (-150 ~ +150)
    speed = constrain(speed, -150, 150);
    
    // 모터 제어
    if (speed > 10) {
        // 전진
        analogWrite(MOTOR_1, speed);
        analogWrite(MOTOR_2, 0);
        analogWrite(MOTOR_3, speed);
        analogWrite(MOTOR_4, 0);
    }
    else if (speed < -10) {
        // 후진
        analogWrite(MOTOR_1, 0);
        analogWrite(MOTOR_2, -speed);
        analogWrite(MOTOR_3, 0);
        analogWrite(MOTOR_4, -speed);
    }
    else {
        // 정지 (작은 오차 무시)
        Stop();
    }
}
```

---

## Slide 12: Kp 값 튜닝

### ⚙️ 비례 상수 조정

```
┌─────────────────────────────────────────────┐
│                                             │
│   Kp 값에 따른 특성:                        │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │ Kp = 1~3 (낮음)                     │  │
│   │ - 느린 반응                         │  │
│   │ - 안정적                            │  │
│   │ - 목표 도달 느림                    │  │
│   │ → 초보자 권장                       │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │ Kp = 4~6 (중간)                     │  │
│   │ - 적당한 반응 속도                  │  │
│   │ - 균형 잡힌 제어                    │  │
│   │ → 일반적 사용                       │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │ Kp = 7~10 (높음)                    │  │
│   │ - 빠른 반응                         │  │
│   │ - 진동 가능성                       │  │
│   │ - 불안정할 수 있음                  │  │
│   │ → 고급자                            │  │
│   └─────────────────────────────────────┘  │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 13: Kp 튜닝 실습

### 🔧 튜닝 절차

```
┌─────────────────────────────────────────────┐
│                                             │
│   Step 1: Kp = 3 으로 시작                  │
│           │                                 │
│           ▼                                 │
│   Step 2: 테스트 실행                       │
│           │                                 │
│           ▼                                 │
│   Step 3: 반응 관찰                         │
│           │                                 │
│      ┌────┼────┬────┐                      │
│      │    │    │    │                      │
│      ▼    ▼    ▼    ▼                      │
│   [너무  [적당] [빠르지만 [진동/                │
│    느림]       불안정]  불안정]              │
│      │    │    │    │                      │
│      ▼    ▼    ▼    ▼                      │
│   [Kp+2] [완료] [Kp-1] [Kp-2]              │
│      │         │    │                      │
│      └─────────┴────┘                      │
│                │                            │
│                ▼                            │
│          [Step 2로]                         │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 14: 실제 ACC 비교

### 🚗 우리 프로젝트 vs 실제 기술

```
┌─────────────────────────────────────────────┐
│                                             │
│   기능               실제 ACC     우리      │
│   ─────────────────────────────────────────│
│   센서               레이더/카메라 초음파   │
│   측정 거리          200m+       4m        │
│   제어 방식          PID 제어   P 제어     │
│   속도 범위          0~200km/h  PWM 0~255  │
│   반응 속도          실시간      ~100ms    │
│   거리 설정          사용자 조절 30cm 고정  │
│   앞차 인식          다중 추적   단일 물체  │
│                                             │
│   실제 ACC의 추가 기능:                     │
│   - Stop & Go: 정차 후 재출발              │
│   - 곡선 주행 보정                          │
│   - 끼어들기 대응                           │
│   - 차선 변경 연동                          │
│                                             │
│   공통점:                                   │
│   - 거리 측정 → 오차 계산 → 속도 제어      │
│   - 피드백 루프 구조                        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 15: 상태 전이 다이어그램

### 🔄 따라가기 상태 머신

```
┌─────────────────────────────────────────────┐
│                                             │
│   ┌─────┐     앞차 감지     ┌──────────┐   │
│   │IDLE │─────────────────▶│FOLLOWING │   │
│   └─────┘                   └────┬─────┘   │
│       ▲                          │         │
│       │                          │         │
│       │    거리 > 100cm          │         │
│       │    (앞차 사라짐)         │         │
│       │                          │         │
│   ┌───┴───┐                      │         │
│   │ LOST  │◀─────────────────────┤         │
│   └───────┘                      │         │
│                                  │         │
│                           ┌──────┼──────┐  │
│                           │      │      │  │
│                           ▼      ▼      ▼  │
│                    ┌──────────────────────┐│
│                    │      FOLLOWING       ││
│                    ├──────────────────────┤│
│                    │ TOO_CLOSE  OPTIMAL   ││
│                    │ (< 25cm)  (25~35cm)  ││
│                    │    │          │      ││
│                    │    ▼          ▼      ││
│                    │  후진/정지   속도유지 ││
│                    │                      ││
│                    │       TOO_FAR        ││
│                    │      (> 35cm)        ││
│                    │          │           ││
│                    │          ▼           ││
│                    │        전진          ││
│                    └──────────────────────┘│
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 16: 테스트 시나리오

### 🧪 따라가기 테스트

```
┌─────────────────────────────────────────────┐
│                                             │
│   시나리오 1: 정지 상태 유지                │
│   ┌─────────────────────────────────────┐  │
│   │  [앞 물체]      30cm      [스마트카]│  │
│   │      ●────────────────────●         │  │
│   │    (정지)               (정지)      │  │
│   │                                     │  │
│   │  예상: 30cm 유지하며 정지           │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   시나리오 2: 앞 물체 전진                  │
│   ┌─────────────────────────────────────┐  │
│   │  [앞 물체]──→   50cm     [스마트카]│  │
│   │      ●────────────────────●         │  │
│   │    (전진)               (추종)      │  │
│   │                                     │  │
│   │  예상: 앞 물체를 따라 전진          │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   시나리오 3: 앞 물체 후진                  │
│   ┌─────────────────────────────────────┐  │
│   │  [앞 물체]←──   15cm     [스마트카]│  │
│   │      ●────────────────────●         │  │
│   │    (후진)               (후진)      │  │
│   │                                     │  │
│   │  예상: 거리 유지하며 후진           │  │
│   └─────────────────────────────────────┘  │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 17: 코드 수정 과제

### ✏️ 실습 1: 기본 따라가기 완성

```arduino
// 빈칸 채우기
void followCar() {
    int currentDist = measureDistance();
    int error = currentDist - 30;  // 목표: 30cm
    
    if (error < -5) {
        // TODO: 후진 코드 작성
        _______________
    }
    else if (error > 10) {
        // TODO: 전진 코드 작성
        _______________
    }
    else {
        // TODO: 정지 코드 작성
        _______________
    }
}
```

---

## Slide 18: 코드 수정 과제

### ✏️ 실습 2: Kp 튜닝

```arduino
// Kp 값을 바꿔가며 최적값 찾기
#define Kp 3  // 시작값

// 테스트 후 기록
// Kp = 3: 반응이 ________
// Kp = 5: 반응이 ________
// Kp = 7: 반응이 ________

// 최적값: Kp = ___
```

---

## Slide 19: 테스트 체크리스트

### ✅ 기능 테스트

| 테스트 항목 | 성공 기준 | Pass |
|-------------|-----------|:----:|
| 거리 측정 | 시리얼에 값 출력 | ☐ |
| 적정 거리 유지 | 30cm ± 5cm | ☐ |
| 앞차 전진 추종 | 부드럽게 따라감 | ☐ |
| 앞차 후진 반응 | 거리 유지하며 후진 | ☐ |
| 앞차 사라짐 | 정지 후 대기 | ☐ |
| Kp 튜닝 | 진동 없이 안정적 | ☐ |
| 급작스런 변화 없음 | 부드러운 가감속 | ☐ |

---

## Slide 20: 트러블슈팅

### 🔧 자주 발생하는 문제

```
┌─────────────────────────────────────────────┐
│ 문제: 차량이 진동하며 움직임                │
├─────────────────────────────────────────────┤
│ 원인                     해결 방법          │
│ ─────────────────────────────────────────── │
│ Kp 값이 너무 높음        Kp 값 감소         │
│ 데드존 없음              속도 임계값 추가   │
│ 측정 노이즈              이동 평균 필터     │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 문제: 반응이 너무 느림                      │
├─────────────────────────────────────────────┤
│ 원인                     해결 방법          │
│ ─────────────────────────────────────────── │
│ Kp 값이 너무 낮음        Kp 값 증가         │
│ 측정 주기 길음           delay 감소        │
│ 모터 속도 느림           PWM 값 증가       │
└─────────────────────────────────────────────┘
```

---

## Slide 21: 확장 아이디어

### 💡 추가 도전 과제

1. **목표 거리 조절**: 앱에서 거리 설정 변경
2. **PI 제어**: 적분 항 추가로 정상 오차 제거
3. **Stop & Go**: 앞차 정지 시 자동 정지/재출발
4. **거리 표시**: LCD에 현재 거리 표시
5. **음성 안내**: "앞 차량과 거리가 좁습니다"

---

## Slide 22: 정리 및 전체 마무리

### 📌 이번 프로젝트 요약

- ✅ 거리 기반 속도 제어 이해
- ✅ 비례 제어 (P 제어) 적용
- ✅ Kp 튜닝 경험
- ✅ 실제 ACC 기술 연계

### 🎓 전체 교육 완료!

**4가지 자율주행 기술 마스터:**
1. 🟢 원격 제어 (STT) → V2X 통신
2. 🟡 라인 트레이서 → LKAS
3. 🟠 장애물 피하기 → AEB
4. 🔴 따라가기 → ACC

---

*© 2025 자동차 따라가기 프로젝트*

