# 🟠 Project 3: 장애물 피하기

---

## Slide 1: 표지

### 🚧 장애물 피하기 자율주행
**초음파 센서 + 서보모터 기반 회피 시스템**

- 실제 자율주행 연계: 자동 긴급 제동 (AEB)
- 난이도: ★★★☆☆ (중급)
- 소요 시간: 3시간

---

## Slide 2: 학습 목표

### 🎯 이 프로젝트를 마치면...

1. **초음파 센서**의 동작 원리를 이해할 수 있다
2. **거리 측정 알고리즘**을 구현할 수 있다
3. **서보모터**로 센서 방향을 제어할 수 있다
4. **장애물 회피 알고리즘**을 구현할 수 있다
5. 실제 **AEB** 기술을 이해할 수 있다

---

## Slide 3: 실제 자율주행 연계

### 🚗 자동 긴급 제동 (AEB) 시스템

```
┌─────────────────────────────────────────────┐
│           실제 AEB 시스템                   │
├─────────────────────────────────────────────┤
│                                             │
│   [라이다/레이더] → [360° 스캔]             │
│          │              │                   │
│          ▼              ▼                   │
│   [물체 감지] → [충돌 예측 알고리즘]        │
│                        │                    │
│                        ▼                    │
│   [충돌 임박?] ── Yes ──→ [자동 브레이크]  │
│        │                                    │
│        No                                   │
│        │                                    │
│        └──→ [경고음/시각 경고]             │
│                                             │
├─────────────────────────────────────────────┤
│           우리 프로젝트                      │
├─────────────────────────────────────────────┤
│                                             │
│   [초음파 센서] → [서보 3방향 스캔]         │
│          │              │                   │
│          ▼              ▼                   │
│   [거리 측정] → [최적 방향 결정]            │
│                        │                    │
│                        ▼                    │
│   [20cm 이내?] ── Yes ──→ [정지 + 회피]    │
│                                             │
└─────────────────────────────────────────────┘
```

**실제 사례**: 볼보 City Safety, 현대 FCA, Euro NCAP 필수 항목

---

## Slide 4: 초음파 센서 동작 원리

### 🦇 박쥐처럼 소리로 측정

```
┌─────────────────────────────────────────────┐
│                                             │
│   초음파 센서 HC-SR04                       │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │  ┌───┐           ┌───┐              │  │
│   │  │ T │  TRIG     │ R │  ECHO        │  │
│   │  │ X │  송신     │ X │  수신        │  │
│   │  └───┘           └───┘              │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   동작 순서:                                │
│                                             │
│   1. TRIG에 10μs HIGH 신호                 │
│      │                                      │
│      ▼                                      │
│   2. 40kHz 초음파 8회 발사                  │
│      │                                      │
│      ▼                                      │
│   3. 물체에서 반사                          │
│      │                                      │
│      ▼                                      │
│   4. ECHO 핀이 HIGH (시간 = 거리 비례)      │
│      │                                      │
│      ▼                                      │
│   5. 거리 = 시간 × 340m/s ÷ 2             │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 5: 거리 계산 공식

### 📐 물리학적 계산

```
┌─────────────────────────────────────────────┐
│                                             │
│   소리의 속도: 340 m/s = 0.034 cm/μs       │
│                                             │
│   ┌─────────────────────────────────────┐  │
│   │                                     │  │
│   │   [센서] ─────── 거리 ──────→ [물체]│  │
│   │      │                        │     │  │
│   │      │←─── 왕복 시간(μs) ───→│     │  │
│   │                                     │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   거리(cm) = 왕복시간(μs) × 0.034 ÷ 2     │
│                                             │
│   예시:                                     │
│   - 왕복 시간: 1000μs                      │
│   - 거리 = 1000 × 0.034 ÷ 2 = 17cm        │
│                                             │
│   코드:                                     │
│   distance = pulseIn(ECHO, HIGH) / 58;     │
│   // 58 = 1,000,000 / 340 / 2 ≈ 58        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 6: 핀 연결 다이어그램

### 🔌 아두이노 연결

```
        Arduino UNO
    ┌─────────────────┐
    │                 │
    │  D7 ──→ TRIG    │  (초음파 송신)
    │  A5 ←── ECHO    │  (초음파 수신)
    │                 │
    │  D13 ─→ SERVO   │  (서보모터)
    │                 │
    │  D5 ──→ Motor1+ │  (오른쪽 전진)
    │  D6 ──→ Motor1- │  (오른쪽 후진)
    │                 │
    │  D11 ─→ Motor2+ │  (왼쪽 전진)
    │  D12 ─→ Motor2- │  (왼쪽 후진)
    │                 │
    │  D8 ──→ PIEZO   │  (경고음)
    │                 │
    │  5V ──→ 센서/서보│
    │  GND ─→ 공통    │
    │                 │
    └─────────────────┘
```

---

## Slide 7: 서보모터 + 초음파 센서 구조

### 🔄 스캔 시스템 구성

```
┌─────────────────────────────────────────────┐
│                                             │
│   측면도 (Side View)                        │
│                                             │
│         ┌─────────────┐                    │
│         │  초음파     │                    │
│         │   센서      │  ← HC-SR04        │
│         └──────┬──────┘                    │
│                │                            │
│         ┌──────┴──────┐                    │
│         │   서보      │                    │
│         │   모터      │  ← SG90           │
│         └──────┬──────┘                    │
│                │                            │
│         ┌──────┴──────┐                    │
│         │   브라켓    │                    │
│         └──────┬──────┘                    │
│                │                            │
│   ═══════════════════════                   │
│           차체                              │
│                                             │
│   평면도 (Top View) - 스캔 각도             │
│                                             │
│           135°    90°    45°               │
│             ╲      │      ╱                │
│              ╲     │     ╱                 │
│               ╲    │    ╱                  │
│                ╲   │   ╱                   │
│                 [센서]                      │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 8: 거리 측정 함수

### 💻 핵심 코드

```arduino
long measureDistance() {
    // 1. TRIG 초기화
    digitalWrite(TRIG, LOW);
    delayMicroseconds(2);
    
    // 2. 초음파 발사 (10μs HIGH)
    digitalWrite(TRIG, HIGH);
    delayMicroseconds(10);
    digitalWrite(TRIG, LOW);
    
    // 3. 반사파 시간 측정
    long duration = pulseIn(ECHO, HIGH, 30000);
    // 30000μs = 약 5m 타임아웃
    
    // 4. 거리 계산 (cm)
    long distance = duration / 58;
    
    // 5. 유효성 검사
    if (distance <= 0 || distance > 400) {
        return 0;  // 측정 실패
    }
    
    return distance;
}
```

---

## Slide 9: 서보모터 스캔 알고리즘

### 🔄 3방향 스캔 순서도

```
┌─────────────────────────────────────────────┐
│                                             │
│   [스캔 시작]                               │
│        │                                    │
│        ▼                                    │
│   [서보 45° 이동] ──→ 오른쪽               │
│        │                                    │
│        ▼                                    │
│   [300ms 대기] ──→ 서보 안정화             │
│        │                                    │
│        ▼                                    │
│   [거리 측정] ──→ rightDist 저장           │
│        │                                    │
│        ▼                                    │
│   [서보 90° 이동] ──→ 정면                 │
│        │                                    │
│        ▼                                    │
│   [300ms 대기]                              │
│        │                                    │
│        ▼                                    │
│   [거리 측정] ──→ frontDist 저장           │
│        │                                    │
│        ▼                                    │
│   [서보 135° 이동] ──→ 왼쪽                │
│        │                                    │
│        ▼                                    │
│   [300ms 대기]                              │
│        │                                    │
│        ▼                                    │
│   [거리 측정] ──→ leftDist 저장            │
│        │                                    │
│        ▼                                    │
│   [서보 90° 복귀]                           │
│        │                                    │
│        ▼                                    │
│   [최대 거리 방향 반환]                     │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 10: 스캔 함수 코드

### 💻 서보 스캔 구현

```arduino
int scanAndDecide() {
    int distances[3];
    int angles[] = {45, 90, 135};  // 우, 정면, 좌
    
    // 3방향 스캔
    for (int i = 0; i < 3; i++) {
        myservo.write(angles[i]);
        delay(300);  // 서보 이동 대기
        distances[i] = measureDistance();
        
        Serial.print("Angle ");
        Serial.print(angles[i]);
        Serial.print(": ");
        Serial.println(distances[i]);
    }
    
    myservo.write(90);  // 정면 복귀
    
    // 최대 거리 방향 결정
    if (distances[0] > distances[1] && 
        distances[0] > distances[2]) {
        return 0;  // 오른쪽
    }
    else if (distances[2] > distances[1]) {
        return 2;  // 왼쪽
    }
    else if (distances[1] > 15) {
        return 1;  // 정면
    }
    else {
        return -1; // 막다른 길
    }
}
```

---

## Slide 11: 장애물 회피 메인 알고리즘

### 🔄 전체 흐름도

```
┌─────────────────────────────────────────────┐
│                                             │
│              [loop 시작]                    │
│                   │                         │
│                   ▼                         │
│              [전진]                         │
│                   │                         │
│                   ▼                         │
│           [거리 측정]                       │
│                   │                         │
│                   ▼                         │
│        [거리 < 20cm?]                       │
│           │           │                     │
│          No          Yes                    │
│           │           │                     │
│           │           ▼                     │
│           │    [정지 + 경고음]              │
│           │           │                     │
│           │           ▼                     │
│           │    [후진 300ms]                 │
│           │           │                     │
│           │           ▼                     │
│           │    [서보 스캔]                  │
│           │           │                     │
│           │           ▼                     │
│           │    [방향 결정]                  │
│           │       │   │   │                │
│           │       ▼   ▼   ▼                │
│           │      우  정면  좌  막힘         │
│           │       │   │   │   │            │
│           │       ▼   ▼   ▼   ▼            │
│           │      우  전진 좌  180°          │
│           │     회전     회전 회전          │
│           │       │   │   │   │            │
│           └───────┴───┴───┴───┘            │
│                       │                     │
│                       ▼                     │
│               [loop 반복]                   │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 12: 회피 코드 구현

### 💻 장애물 회피 핵심 코드

```arduino
void avoidObstacle() {
    int frontDist = measureDistance();
    
    // 20cm 이내 장애물 감지
    if (frontDist > 0 && frontDist < 20) {
        // 1. 정지 및 경고
        Stop();
        tone(PIEZO, 1000, 200);
        
        // 2. 후진
        Backward();
        delay(300);
        Stop();
        
        // 3. 스캔
        int direction = scanAndDecide();
        
        // 4. 회피 동작
        switch (direction) {
            case 0:  // 오른쪽
                Right();
                delay(500);
                break;
            case 2:  // 왼쪽
                Left();
                delay(500);
                break;
            case 1:  // 정면 (여유 있음)
                // 전진 계속
                break;
            case -1: // 막다른 길
                Left();
                delay(1000);  // 180° 회전
                break;
        }
        Stop();
    } else {
        Forward();  // 장애물 없음 - 전진
    }
}
```

---

## Slide 13: 실제 AEB 비교

### 🚗 우리 프로젝트 vs 실제 기술

```
┌─────────────────────────────────────────────┐
│                                             │
│   기능               실제 AEB     우리      │
│   ─────────────────────────────────────────│
│   센서               라이다/레이더 초음파   │
│   스캔 범위          360°        ~180°     │
│   측정 거리          200m+       4m        │
│   처리 속도          실시간      ~100ms    │
│   경고 방식          HUD/소리   부저       │
│   제동 방식          ABS/ESC    DC모터정지 │
│   회피 방식          자동 조향   회전       │
│                                             │
│   공통점:                                   │
│   - 거리 기반 장애물 감지                   │
│   - 충돌 전 자동 정지                       │
│   - 회피 경로 탐색                          │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 14: 막다른 길 처리

### 🔄 모든 방향 막힌 경우

```
┌─────────────────────────────────────────────┐
│                                             │
│   상황: 모든 방향 거리 < 15cm               │
│                                             │
│           ┌───────┐                        │
│           │ 벽    │                        │
│           └───────┘                        │
│        ┌───┐   ▲   ┌───┐                  │
│        │벽 │ [차] │벽 │                   │
│        └───┘       └───┘                  │
│                                             │
│   해결 전략:                                │
│                                             │
│   1. 경고음 3회                             │
│   2. 180° 회전 (약 1000ms 좌회전)          │
│   3. 전진 재개                              │
│                                             │
│   코드:                                     │
│   if (direction == -1) {                   │
│       tone(PIEZO, 1000, 100);              │
│       delay(200);                          │
│       tone(PIEZO, 1000, 100);              │
│       delay(200);                          │
│       tone(PIEZO, 1000, 100);              │
│       Left();                              │
│       delay(1000);  // 180°                │
│       Stop();                              │
│   }                                        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 15: 코드 수정 과제

### ✏️ 실습 1: 랜덤 → 스마트 회피

**현재 코드 (비효율적)**:
```arduino
int toggle = random(2, 4);  // 무작위 방향
```

**수정 목표**:
```arduino
int direction = scanAndDecide();  // 스캔 후 결정
```

---

## Slide 16: 코드 수정 과제

### ✏️ 실습 2: 감지 거리 조정

**목표**: 더 빠른 반응을 위해 감지 거리 확대

```arduino
// 수정 전
if (frontDist > 0 && frontDist < 10) {  // 10cm

// 수정 후
if (frontDist > 0 && frontDist < 20) {  // 20cm로 확대

// 추가: 단계별 반응
if (frontDist < 10) {
    // 긴급: 즉시 정지 + 후진
} else if (frontDist < 20) {
    // 주의: 감속 + 스캔 준비
} else if (frontDist < 30) {
    // 안전: 속도 유지
}
```

---

## Slide 17: 테스트 코스 설계

### 🛤️ 장애물 배치

```
┌─────────────────────────────────────────────┐
│                                             │
│   기본 코스 (장애물 1개)                    │
│   ┌─────────────────────────────────────┐  │
│   │  S                                  │  │
│   │  │        ┌───┐                    │  │
│   │  └────────│ 1 │────────────── G    │  │
│   │           └───┘                    │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   중급 코스 (장애물 3개)                    │
│   ┌─────────────────────────────────────┐  │
│   │  S                                  │  │
│   │  │      ┌───┐                      │  │
│   │  └──┐   │ 1 │   ┌───┐              │  │
│   │     │   └───┘   │ 2 │    ┌───┐     │  │
│   │     └───────────└───┘────│ 3 │── G │  │
│   │                          └───┘     │  │
│   └─────────────────────────────────────┘  │
│                                             │
│   고급 코스 (막다른 길 포함)                │
│   ┌─────────────────────────────────────┐  │
│   │  S     ┌───────────────┐            │  │
│   │  │     │   막다른 길   │            │  │
│   │  └──┐  │   ┌───┐      │            │  │
│   │     │  │   │ X │      │            │  │
│   │     └──┼───┤   ├──────┼────── G    │  │
│   │        │   └───┘      │            │  │
│   │        └───────────────┘            │  │
│   └─────────────────────────────────────┘  │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Slide 18: 테스트 체크리스트

### ✅ 기능 테스트

| 테스트 항목 | 성공 기준 | Pass |
|-------------|-----------|:----:|
| 거리 측정 | 시리얼에 값 출력 | ☐ |
| 서보 동작 | 45°/90°/135° 이동 | ☐ |
| 장애물 감지 | 20cm에서 정지 | ☐ |
| 경고음 | 장애물 감지 시 부저 | ☐ |
| 스캔 동작 | 3방향 측정 완료 | ☐ |
| 회피 동작 | 빈 공간으로 이동 | ☐ |
| 막다른 길 | 180° 회전 | ☐ |
| 연속 회피 | 3개 장애물 통과 | ☐ |

---

## Slide 19: 트러블슈팅

### 🔧 자주 발생하는 문제

```
┌─────────────────────────────────────────────┐
│ 문제: 거리 측정값이 0 또는 이상한 값        │
├─────────────────────────────────────────────┤
│ 원인                     해결 방법          │
│ ─────────────────────────────────────────── │
│ TRIG/ECHO 핀 오류        핀 연결 확인       │
│ 전원 부족                5V 확인           │
│ 측정 범위 초과           2cm~4m 내 확인    │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 문제: 서보모터가 떨림                       │
├─────────────────────────────────────────────┤
│ 원인                     해결 방법          │
│ ─────────────────────────────────────────── │
│ 전류 부족                외부 전원 사용     │
│ 연속 제어                detach() 사용     │
│ PWM 노이즈               커패시터 추가     │
└─────────────────────────────────────────────┘
```

---

## Slide 20: 확장 아이디어

### 💡 추가 도전 과제

1. **5방향 정밀 스캔**: 30°, 60°, 90°, 120°, 150°
2. **속도 연동**: 거리에 따라 속도 자동 조절
3. **연속 스캔 주행**: 전진하면서 실시간 스캔
4. **히트맵 생성**: 스캔 결과를 시리얼로 전송
5. **음성 안내**: "왼쪽으로 회피합니다"

---

## Slide 21: 정리 및 다음 단계

### 📌 이번 프로젝트 요약

- ✅ 초음파 센서 동작 원리 이해
- ✅ 거리 측정 알고리즘 구현
- ✅ 서보모터 스캔 구현
- ✅ 장애물 회피 알고리즘 완성
- ✅ 실제 AEB 기술 연계

### ➡️ 다음 프로젝트

**🔴 Project 4: 자동차 따라가기**
- 초음파 센서로 앞 차량 거리 유지
- 비례 제어 (P 제어) 구현
- 실제 ACC 기술 체험

---

*© 2025 장애물 피하기 프로젝트*

